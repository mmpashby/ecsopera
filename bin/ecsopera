#!/usr/bin/env python
# pylint: disable=C0111,C0103,C1801,E0611,E1120,R0902,R0913,R0201,W0511,W0622
import sys
import logging
import click
from ecsopera.awscommands import (get_version,
                                   aws_ecs_ami_update,
                                   aws_ecs_deploy,
                                   aws_s3cp_cloudfront_deploy)
from ecsopera.loghelper import LogHelper


@click.group()
@click.pass_context
@click.option('--awsaccesskey',
              envvar='AWS_ACCESS_KEY_ID',
              default=None,
              type=str)
@click.option('--awssecretkey',
              envvar='AWS_SECRET_ACCESS_KEY',
              default=None,
              type=str)
@click.option('--awsregion',
              envvar='AWS_DEFAULT_REGION',
              default=None,
              type=str)
@click.option('--debug',
              is_flag=True,
              help="Debug mode for true verbose output.")
def ecsopera(ecsoperaaccess, awsaccesskey, awssecretkey, awsregion, debug):
    # TODO: Create decorator or better way of dealing with different
    # providers in future.
    if debug:
        log_level = logging.DEBUG
    else:
        log_level = logging.INFO
    log = LogHelper(stream=sys.stdout,
                    level=log_level,
                    fmt='%(asctime)s %(levelname)s %(message)s')
    if awsaccesskey is None or awssecretkey is None or awsregion is None:
        log.error("No provided value for awsaccesskey/awssecretkey/awsregion."
                  "Safely Exiting....")
        sys.exit(0)
    ecsoperaaccess.obj = {'accesskey': awsaccesskey,
                           'secretkey': awssecretkey,
                           'region': awsregion,
                           'logger': log}


@click.command('version',
               short_help="Get the current version number.")
@click.pass_obj
def version(ecsoperaaccess):
    get_version(ecsoperaaccess['logger'])


@click.command('aws-ecs-amiupdate',
               short_help='Update the container instance AMI.')
@click.option('--ami', help="The AMI image to ++ to.", default=None, type=str)
@click.option('--cluster',
              help="The ECS cluster name to operate on.",
              default=None, type=str)
@click.option('--launchcfg',
              help="The Launch Configuration name to operate on.",
              default=None,
              type=str)
@click.option('--timeout',
              help="Timeout (s) value for spinning up new container instances "
                   "and performing draining on existing instances. "
                   "(default 300s (5 mins)).",
              default=300,
              type=int)
@click.pass_obj
def aws_amiupdate(ecsoperaaccess, ami, cluster, launchcfg, timeout):
    aws_ecs_ami_update(ecsoperaaccess['accesskey'],
                       ecsoperaaccess['secretkey'],
                       ami,
                       cluster,
                       launchcfg,
                       timeout,
                       ecsoperaaccess['logger'])


@click.command('aws-ecs-deploy',
               short_help="Use this command to deploy a new task definition "
                          "to a specified ECS service.")
@click.option('--servicename',
              help="The ECS service name to operate on.",
              default=None, type=str)
@click.option('--cluster',
              help="The ECS cluster name to operate on.",
              default=None,
              type=str)
@click.option('--image',
              help="The Docker Image Repo location.",
              default=None,
              type=str)
@click.option('--desiredcount',
              help="The number of instantiations of the task to place "
                   "and keep running in your service.",
              default=2,
              type=int)
@click.option('--min',
              help="minumumHealthyPercent: The lower limit on the number of "
                   "running tasks during a deployment. (default: 100)",
              default=100,
              type=int)
@click.option('--max',
              help="maximumPercent: The upper limit on the number of running "
                   "tasks during a deployment. (default: 200)",
              default=200,
              type=int)
@click.option('--timeout',
              help="Timeout value for checking for successful deployment. "
                   "(default 5 mins).",
              default=300,
              type=int)
@click.pass_obj
def aws_ecsdeploy(ecsoperaaccess,
                  servicename,
                  cluster,
                  image,
                  desiredcount,
                  min,
                  max,
                  timeout):
    aws_ecs_deploy(ecsoperaaccess['accesskey'],
                   ecsoperaaccess['secretkey'],
                   servicename,
                   cluster,
                   image,
                   desiredcount,
                   min,
                   max,
                   timeout,
                   ecsoperaaccess['logger'])


@click.command('aws-s3cpcloudfront-deploy',
               short_help="Use this command to copy objects to an s3 bucket "
                          "and perform cloudfront related ops.")
@click.option('--source',
              help="The source of files to copy. Can be another s3 bucket "
                   "(affixed with s3:// (s3Uri format)) or absolute path.",
              default=None,
              type=str)
@click.option('--destination',
              help="The destination s3 bucket (affixed with s3:// "
                   "(s3Uri format)) to cp files to.",
              default=None,
              type=str)
@click.option('--expires',
              help="The date and time the object is no longer cacheable "
                   "but this is soon deprecated.",
              default=None,
              type=str)
@click.option('--cflistdistid',
              help="The cloudfront distribution list id to invalidate.",
              default=None,
              type=str)
@click.option('--max-age',
              help="Specifies the maximum amount of time the resources "
                   "will be considered fresh. This will apply to all "
                   "resources that are uploaded.",
              default=0,
              type=int)
@click.option('--cleardst/--no-cleardst',
              help="Specifies whether to clear the dst bucket",
              default=False)
@click.option('--invalcache/--no-invalcache',
              help="Specifies whether to invalidate the cloudfront cache "
                   "during this task.",
              default=False)
@click.option('--timeout',
              help="Timeout value for checking for successful s3cp deploy. "
                   "(default 5 mins).",
              default=300,
              type=int)
@click.pass_obj
def aws_s3cpcloudfront(ecsoperaaccess,
                       source,
                       destination,
                       expires,
                       cflistdistid,
                       max_age,
                       cleardst,
                       invalcache,
                       timeout):
    aws_s3cp_cloudfront_deploy(ecsoperaaccess['accesskey'],
                               ecsoperaaccess['secretkey'],
                               source,
                               destination,
                               expires,
                               cflistdistid,
                               max_age,
                               cleardst,
                               invalcache,
                               timeout,
                               ecsoperaaccess['logger'])


# Provider Commands
ecsopera.add_command(version)
ecsopera.add_command(aws_amiupdate)
ecsopera.add_command(aws_ecsdeploy)
ecsopera.add_command(aws_s3cpcloudfront)

if __name__ == "__main__":
    ecsopera()
